From 472e557a9bc7a70caa5d7bc435601848a6ed8d7a Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Mon, 27 Mar 2017 23:37:36 +0100
Subject: [PATCH 04/14] Use /boot for the ESP mount, do not allow copying any
 files to it

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 os_installer2/pages/progress.py | 4 ++--
 os_installer2/postinstall.py    | 6 +++---
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/os_installer2/pages/progress.py b/os_installer2/pages/progress.py
index d5b7171..7e7e5b9 100644
--- a/os_installer2/pages/progress.py
+++ b/os_installer2/pages/progress.py
@@ -244,7 +244,7 @@ class InstallerProgressPage(BasePage):
         """ Mount the ESP into the root """
         self.set_display_string("Mounting EFI System Partition")
         root = self.get_installer_target_filesystem()
-        fpath = os.path.join(root, "boot/efi")
+        fpath = os.path.join(root, "boot")
         if not os.path.exists(fpath):
             try:
                 os.makedirs(fpath, mode=0o755)
@@ -390,7 +390,7 @@ class InstallerProgressPage(BasePage):
 
             # Do we skip this guy? Don't traverse what we don't need
             dir_base = dir_root.split("/")[0]
-            if dir_base in ["home", "lost+found"]:
+            if dir_base in ["home", "lost+found", "boot"]:
                 continue
 
             # Create the container directory first
diff --git a/os_installer2/postinstall.py b/os_installer2/postinstall.py
index 33cb37d..2bb5562 100644
--- a/os_installer2/postinstall.py
+++ b/os_installer2/postinstall.py
@@ -577,15 +577,15 @@ class PostInstallFstab(PostInstallStep):
 
         ext4_ops = "rw,relatime,errors=remount-ro"
 
-        # Add the ESP to /boot/efi
+        # Add the ESP to /boot
         if strat.is_uefi() and self.info.bootloader_install:
             esp = self.installer.locate_esp()
             uuid = get_part_uuid(esp, True)
             if uuid:
-                esp_ent = "PARTUUID={}\t/boot/efi\tvfat\tdefaults\t0\t0"
+                esp_ent = "PARTUUID={}\t/boot\tvfat\tdefaults\t0\t0"
                 appends.append(esp_ent.format(uuid))
             else:
-                esp_ent = "{}\t/boot/efi\tvfat\tdefaults\t0\t0"
+                esp_ent = "{}\t/boot\tvfat\tdefaults\t0\t0"
                 appends.append(esp_ent.format(esp))
 
         for op in strat.get_operations():
-- 
2.12.2

