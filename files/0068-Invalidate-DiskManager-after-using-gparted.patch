From 948e49d72a6b492c1d961d888eb4cd0f25d3c4dd Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sun, 12 Jun 2016 21:34:18 +0100
Subject: [PATCH 68/84] Invalidate DiskManager after using gparted

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 os_installer2/mainwindow.py          |  2 ++
 os_installer2/pages/disk_location.py |  4 +++-
 os_installer2/pages/partitioning.py  | 16 +++++++++++++++-
 3 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/os_installer2/mainwindow.py b/os_installer2/mainwindow.py
index dde779b..f1dc5d9 100644
--- a/os_installer2/mainwindow.py
+++ b/os_installer2/mainwindow.py
@@ -73,6 +73,8 @@ class InstallInfo:
     bootloader_sz = None
     bootloader_install = False
 
+    invalidated = False
+
     def __init__(self):
         self.users = list()
         self.bootloader_install = True
diff --git a/os_installer2/pages/disk_location.py b/os_installer2/pages/disk_location.py
index b603bdc..93a433a 100644
--- a/os_installer2/pages/disk_location.py
+++ b/os_installer2/pages/disk_location.py
@@ -283,8 +283,10 @@ class InstallerDiskLocationPage(BasePage):
 
     def init_view(self):
         """ Prepare for viewing... """
-        if self.had_init:
+        if self.had_init and not self.info.invalidated:
             return
+        self.info.invalidated = False
+        self.can_continue = False
         self.had_init = True
         self.stack.set_visible_child_name("loading")
         self.spinner.start()
diff --git a/os_installer2/pages/partitioning.py b/os_installer2/pages/partitioning.py
index 3012a07..ebc8fea 100644
--- a/os_installer2/pages/partitioning.py
+++ b/os_installer2/pages/partitioning.py
@@ -18,7 +18,7 @@ from os_installer2.strategy import ReplaceOSStrategy
 from os_installer2.strategy import EmptyDiskStrategy
 from os_installer2.strategy import WipeDiskStrategy
 from os_installer2.strategy import UserPartitionStrategy
-from os_installer2.diskman import SystemPartition
+from os_installer2.diskman import SystemPartition, DriveProber
 from gi.repository import Gtk, GLib
 import sys
 import os
@@ -153,12 +153,26 @@ class ManualPage(Gtk.VBox):
             os.system("gparted")
         except:
             pass
+
+        perms = self.info.owner.get_perms_manager()
+        dm = self.info.owner.get_disk_manager()
+
+        prober = DriveProber(dm)
+        self.info.prober = prober
+        self.info.prober.probe()
         perms.down_permissions()
+        self.info.invalidated = True
+        self.selection_root = None
+        self.selection_home = None
+        self.selection_swap = None
+
         GLib.idle_add(self.restore_ui)
 
     def restore_ui(self):
         self.info.owner.set_sensitive(True)
         self.queue_draw()
+        self.populate_ui()
+        self.update_selection()
         # TODO: Refresh
 
     def on_mount_changed(self, widget, path, text):
-- 
2.8.3

