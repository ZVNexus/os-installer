From 45560624a7658b119f1c32b1e6fdf52e09ce5662 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sat, 11 Jun 2016 21:12:50 +0100
Subject: [PATCH 29/34] Skip tiny drives altogether, save the UI from bugging
 out

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 os_installer2/__init__.py            | 5 +++++
 os_installer2/diskman.py             | 6 ++++++
 os_installer2/pages/disk_location.py | 6 ++++--
 os_installer2/pages/partitioning.py  | 3 +--
 os_installer2/strategy.py            | 4 +---
 5 files changed, 17 insertions(+), 7 deletions(-)

diff --git a/os_installer2/__init__.py b/os_installer2/__init__.py
index 3486180..64c4a64 100644
--- a/os_installer2/__init__.py
+++ b/os_installer2/__init__.py
@@ -26,6 +26,11 @@ SOURCE_FILESYSTEM = "/run/initramfs/live/LiveOS/squashfs.img"
 # The guy inside that is actually our filesystem to copy
 INNER_FILESYSTEM = "LiveOS/rootfs.img"
 
+# Absolute minimum size
+MB = 1000 * 1000
+GB = 1000 * MB
+MIN_REQUIRED_SIZE = 10 * GB
+
 
 def get_resource_path():
     bsPath = os.path.dirname(__file__)
diff --git a/os_installer2/diskman.py b/os_installer2/diskman.py
index b7d1974..f145f31 100644
--- a/os_installer2/diskman.py
+++ b/os_installer2/diskman.py
@@ -12,6 +12,7 @@
 #
 
 from . import format_size_local
+from . import MIN_REQUIRED_SIZE
 import re
 import os
 import subprocess
@@ -76,6 +77,11 @@ class DriveProber:
                 if device.readOnly:
                     print("DEBUG: Skipping read-only device")
                     continue
+                size = device.getLength() * device.sectorSize
+                if size < MIN_REQUIRED_SIZE:
+                    print("DEBUG: Skipping tiny drive: {}".format(
+                          device.path))
+                    continue
             except Exception as e:
                 print("Cannot probe device: {} {}".format(item, e))
                 continue
diff --git a/os_installer2/pages/disk_location.py b/os_installer2/pages/disk_location.py
index e1717dc..b603bdc 100644
--- a/os_installer2/pages/disk_location.py
+++ b/os_installer2/pages/disk_location.py
@@ -159,8 +159,10 @@ class WhoopsPage(Gtk.VBox):
         self.pack_start(img, False, False, 10)
 
         label = Gtk.Label("<big>{}</big>".format(
-                          "Oh no! Your system has no disks available.\n"
-                          "There is nowhere to install Solus."))
+                          "Oh no! Your system has no usable disks available.\n"
+                          "There is nowhere to install Solus.\n"
+                          "Please ensure you have a minimum of 10GB available"
+                          "\nstorage to complete a full Solus installation."))
         label.set_property("xalign", 0.5)
         label.set_use_markup(True)
         self.pack_start(label, False, False, 10)
diff --git a/os_installer2/pages/partitioning.py b/os_installer2/pages/partitioning.py
index beea3f2..b9d066f 100644
--- a/os_installer2/pages/partitioning.py
+++ b/os_installer2/pages/partitioning.py
@@ -12,13 +12,12 @@
 #
 
 from .basepage import BasePage
-from os_installer2 import format_size_local
+from os_installer2 import format_size_local, MIN_REQUIRED_SIZE
 from os_installer2.strategy import DualBootStrategy
 from os_installer2.strategy import ReplaceOSStrategy
 from os_installer2.strategy import EmptyDiskStrategy
 from os_installer2.strategy import WipeDiskStrategy
 from os_installer2.strategy import UserPartitionStrategy
-from os_installer2.strategy import MIN_REQUIRED_SIZE
 from gi.repository import Gtk, GLib
 import sys
 import os
diff --git a/os_installer2/strategy.py b/os_installer2/strategy.py
index f0e1f34..dcb204c 100644
--- a/os_installer2/strategy.py
+++ b/os_installer2/strategy.py
@@ -20,10 +20,8 @@ from .diskops import DiskOpCreateESP
 from .diskops import DiskOpFormatRoot
 from .diskops import DiskOpResizeOS
 from .diskops import DiskOpUseSwap
+from . import MIN_REQUIRED_SIZE, MB, GB
 
-MB = 1000 * 1000
-GB = 1000 * MB
-MIN_REQUIRED_SIZE = 10 * GB
 SWAP_USE_THRESHOLD = 15 * GB
 ESP_FREE_REQUIRED = 60 * MB
 ESP_MIN_SIZE = 512
-- 
2.8.3

