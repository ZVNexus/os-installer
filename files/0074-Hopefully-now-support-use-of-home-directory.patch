From b2fab3e5c0d56d9fd3e829b9bffcbe49cc99471e Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sun, 12 Jun 2016 22:54:11 +0100
Subject: [PATCH 74/81] Hopefully now support use of home directory..

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 os_installer2/pages/progress.py | 21 +++++++++++++++++++++
 os_installer2/strategy.py       |  9 +++++++++
 2 files changed, 30 insertions(+)

diff --git a/os_installer2/pages/progress.py b/os_installer2/pages/progress.py
index bb0ae8c..e25e373 100644
--- a/os_installer2/pages/progress.py
+++ b/os_installer2/pages/progress.py
@@ -581,6 +581,21 @@ class InstallerProgressPage(BasePage):
         self.mount_tracker[root] = target
 
         print("DEBUG: / ({}) mounted at {}".format(root, target))
+        return True
+
+    def maybe_mount_home(self):
+        strategy = self.info.strategy
+        home = strategy.get_home_dir()
+        if not home:
+            return True
+        target = os.path.join(self.get_installer_target_filesystem(),
+                              "home")
+        if not self.dm.do_mount(home, target, "auto", "rw"):
+            self.set_error_message("Cannot mount home partition")
+            return False
+        self.mount_tracker[home] = target
+
+        print("DEBUG: /home ({}) mounted at {}".format(home, target))
         # TODO: Mount home if it is needed
         return True
 
@@ -642,6 +657,12 @@ class InstallerProgressPage(BasePage):
             return False
         self.filesystem_copying = False
 
+        if not self.maybe_mount_home():
+            self.set_error_message("Failed to mount /home")
+            self.unmount_all()
+            self.installing = False
+            return False
+
         time.sleep(1)
         self.set_display_string("Initializing post-installs")
         for ptype in self.post_install_enabled:
diff --git a/os_installer2/strategy.py b/os_installer2/strategy.py
index 4910912..1521add 100644
--- a/os_installer2/strategy.py
+++ b/os_installer2/strategy.py
@@ -61,6 +61,9 @@ class DiskStrategy:
 
     supports_extended_partition = False
 
+    def get_home_dir(self):
+        return None
+
     def get_root_partition(self):
         print("FATAL: Unimplemented strategy!!")
         return None
@@ -588,6 +591,12 @@ class UserPartitionStrategy(DiskStrategy):
     swap_part = None
     swap_format = False
 
+    def get_home_dir(self):
+        for op in self.get_operations():
+            if not isinstance(op, DiskOpUseHome):
+                continue
+            return op.path
+
     def set_root_partition(self, part):
         """ Set the root partition to use """
         self.root_part = part
-- 
2.8.3

